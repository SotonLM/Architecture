name: PR CI

on:
  pull_request:
    branches: [ main, next-release ]
  push:
    branches: [ main, next-release ]

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: astral-sh/setup-uv@v2
      - name: Prepare environment
        run: |
          if [ -f pyproject.toml ]; then
            uv sync --all-extras --dev
          elif [ -f requirements.txt ]; then
            uv pip install --system -r requirements.txt
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: astral-sh/setup-uv@v2
      - name: Prepare environment
        run: |
          if [ -f pyproject.toml ]; then
            uv sync --all-extras --dev
          elif [ -f requirements.txt ]; then
            uv pip install --system -r requirements.txt
          fi
      - name: Run linters
        run: |
          files="$(git ls-files '*.py')"
          if [ -n "$files" ]; then
            if [ -f pyproject.toml ]; then
              uv run python -m py_compile $files || true
            else
              python -m py_compile $files || true
            fi
          fi
          if [ -f pyproject.toml ]; then
            uv run ruff . || true
          else
            uv tool run --from ruff ruff . || true
          fi
    continue-on-error: false

  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: astral-sh/setup-uv@v2
      - name: Prepare environment
        run: |
          if [ -f pyproject.toml ]; then
            uv sync --all-extras --dev
          elif [ -f requirements.txt ]; then
            uv pip install --system -r requirements.txt
          fi
      - name: Run tests
        run: |
          if [ -f pyproject.toml ]; then
            uv run pytest -q
          else
            uv tool run --from pytest pytest -q
          fi
