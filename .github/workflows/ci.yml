name: PR CI

on:
  pull_request:
    branches: [ main, next-release ]
  push:
    branches: [ main, next-release ]

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: astral-sh/setup-uv@v2
      - name: Prepare environment
        run: |
          if [ -f pyproject.toml ]; then
            # for feature branches we don't need to pull *all* heavy extras
            if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/next-release" ]; then
              uv sync --all-extras --dev
            else
              uv sync --dev
            fi
          elif [ -f requirements.txt ]; then
            uv pip install --system -r requirements.txt
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: astral-sh/setup-uv@v2
      - name: Prepare environment
        run: |
          if [ -f pyproject.toml ]; then
            if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/next-release" ]; then
              uv sync --all-extras --dev
            else
              uv sync --dev
            fi
            uv pip install --system ".[dev]"
          elif [ -f requirements.txt ]; then
            uv pip install --system -r requirements.txt
          fi
      - name: Run linters
        run: |
          files="$(git ls-files '*.py')"
          if [ -n "$files" ]; then
            python -m py_compile $files
          fi
          python -m ruff check .

  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: astral-sh/setup-uv@v2
      - name: Prepare environment
        run: |
          if [ -f pyproject.toml ]; then
            if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/next-release" ]; then
              uv sync --all-extras --dev
            else
              uv sync --dev
            fi
            uv pip install --system ".[dev]"
          elif [ -f requirements.txt ]; then
            uv pip install --system -r requirements.txt
          fi
      - name: Run tests
        run: |
          python -m pytest -q
